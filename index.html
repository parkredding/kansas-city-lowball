<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Prevent browser caching of this HTML file -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Kansas City Lowball</title>
  </head>
  <body>
    <div id="root"></div>
    <script>
      // GitHub Pages SPA routing - restore path from 404 redirect
      (function() {
        var redirect = sessionStorage.getItem('spa-redirect');
        if (redirect) {
          sessionStorage.removeItem('spa-redirect');
          // Use replaceState to restore the proper URL without adding to history
          window.history.replaceState(null, null,
            window.location.pathname.replace(/\/$/, '') + '/' + redirect
          );
        }
      })();
    </script>
    <script>
      // Version checker for cache busting
      (function() {
        var VERSION_KEY = 'kcl-app-version';
        var BASE_PATH = '/kansas-city-lowball/';
        
        function checkVersion() {
          fetch(BASE_PATH + 'version.json?t=' + Date.now(), { cache: 'no-store' })
            .then(function(res) { return res.json(); })
            .then(function(data) {
              var currentVersion = localStorage.getItem(VERSION_KEY);
              if (currentVersion && currentVersion !== data.version) {
                console.log('New version detected, clearing cache and reloading...');
                localStorage.setItem(VERSION_KEY, data.version);
                
                // Clear all caches, then navigate to a cache-busted URL.
                // NOTE: reload(true) is deprecated and ignored by modern browsers,
                // so we change the URL instead â€” a different URL is a different
                // cache key, forcing the browser to fetch the new HTML which
                // references the updated content-hashed CSS/JS assets.
                var reload = function() {
                  window.location.href = window.location.pathname + '?v=' + data.version;
                };
                if ('caches' in window) {
                  caches.keys()
                    .then(function(names) {
                      return Promise.all(names.map(function(name) {
                        return caches.delete(name);
                      }));
                    })
                    .then(reload)
                    .catch(reload);
                } else {
                  reload();
                }
              } else if (!currentVersion) {
                localStorage.setItem(VERSION_KEY, data.version);
              }
            })
            .catch(function(err) {
              console.log('Version check failed:', err);
            });
        }
        
        // Check version on page load
        checkVersion();
        
        // Also check when page becomes visible (user returns to tab)
        document.addEventListener('visibilitychange', function() {
          if (document.visibilityState === 'visible') {
            checkVersion();
          }
        });
      })();
    </script>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
